# RAG 系统性能测试指南

## 概述

`benchmark.py` 脚本用于全面测试和统计 RAG 系统的性能指标，帮助你了解系统的运行效率和资源使用情况。

## 功能特性

### 1. 构建性能测试
- ✅ 文档加载时间
- ✅ 文档分割时间
- ✅ 向量化时间（嵌入模型处理时间）
- ✅ 向量存储创建时间
- ✅ 向量存储保存时间
- ✅ 问答链创建时间
- ✅ 内存使用情况

### 2. 查询性能测试
- ✅ 查询响应时间（总时间）
- ✅ 平均/最快/最慢查询时间
- ✅ 查询吞吐量（QPS - 每秒查询数）
- ✅ 检索文档数量统计

### 3. 向量存储加载测试
- ✅ 加载已保存向量存储的时间
- ✅ 加载后的内存使用

## 使用方法

### 使用 uv 运行（推荐）

```bash
# 在项目根目录下运行
cd /home/lab/Projects/hylreg_LLM

# 使用 uv 运行性能测试
uv run python demo/RAG/benchmark.py

# 设置环境变量（使用 Ollama）
USE_OLLAMA=true uv run python demo/RAG/benchmark.py
```

### 使用传统 Python 运行

```bash
# 从项目根目录运行
cd /home/lab/Projects/hylreg_LLM
python demo/RAG/benchmark.py
```

### 环境配置

在运行测试前，确保已设置相应的环境变量：

```bash
# 使用 Ollama（推荐）
export USE_OLLAMA=true

# 或使用其他后端
export SILICONFLOW_API_KEY="your-key"
export SILICONFLOW_BASE_URL="https://api.siliconflow.cn/v1/"
```

### 依赖安装

#### 使用 uv（推荐）

`psutil` 是可选依赖，用于内存监控。如果需要内存监控功能：

```bash
# 添加 psutil 到项目依赖
uv add psutil

# 或者临时安装
uv pip install psutil
```

#### 使用传统 pip

```bash
pip install psutil
```

如果没有安装 `psutil`，脚本仍可运行，但不会显示内存使用情况。

## 测试流程

脚本会自动执行以下测试：

1. **构建性能测试**：测试完整的 RAG 系统构建流程
2. **向量存储加载测试**：测试从磁盘加载已保存向量存储的性能
3. **查询性能测试**：测试多个查询的响应时间和吞吐量

## 输出结果

### 控制台输出

测试过程中会实时显示各项指标：

```
============================================================
开始测试 RAG 系统构建性能...
============================================================
✓ 文档加载完成: 0.123 秒 (1 个文档)
✓ 文档分割完成: 0.045 秒 (5 个块)
✓ 向量化完成: 2.345 秒
✓ 向量存储保存完成: 0.012 秒
✓ 问答链创建完成: 0.234 秒

✓ 构建总耗时: 2.759 秒
✓ 内存使用: 245.32 MB (增量: 120.45 MB)
```

### JSON 报告

测试完成后会生成 `performance_report.json` 文件，包含详细的性能指标：

```json
{
  "测试时间": "2024-01-15 10:30:00",
  "系统配置": {
    "嵌入模型": "qwen3-embedding:0.6b",
    "LLM模型": "qwen3:0.6b",
    "文档路径": "./documents",
    "块大小": 1000,
    "块重叠": 200
  },
  "性能指标": {
    "总耗时": "2.76 秒",
    "内存使用": "245.32 MB",
    "指标详情": {
      "文档加载时间": {
        "平均值": "0.123 秒",
        "次数": 1
      },
      "向量化时间": {
        "平均值": "2.345 秒",
        "次数": 1
      },
      "平均查询时间": {
        "平均值": "1.234 秒",
        "次数": 4
      }
    }
  }
}
```

## 性能指标说明

### 时间指标

- **文档加载时间**：从文件系统读取文档的时间
- **文档分割时间**：将文档分割成块的时间
- **向量化时间**：使用嵌入模型将文档块转换为向量的时间
  - 这是构建过程中最耗时的步骤
  - 速度取决于嵌入模型的性能和文档数量
- **查询时间**：从提交问题到获得答案的总时间
  - 包括：检索时间 + 重排序时间（如果启用）+ LLM 生成时间

### 吞吐量指标

- **向量化速度**：每秒处理的文档块数量（块/秒）
- **查询吞吐量**：每秒处理的查询数量（查询/秒，QPS）

### 资源指标

- **内存使用**：RAG 系统占用的内存（MB）
- **内存增量**：构建前后内存的增量

## 性能优化建议

### 1. 向量化速度优化

- 使用更快的嵌入模型（如更小的模型）
- 减少文档块数量（增大 `chunk_size`）
- 使用 GPU 加速（如果可用）

### 2. 查询速度优化

- 减少检索的文档数量（减小 `k` 参数）
- 禁用重排序（如果不需要）
- 使用更快的 LLM 模型
- 使用已保存的向量存储（避免每次重新构建）

### 3. 内存优化

- 使用更小的嵌入模型
- 减少 `chunk_size` 和 `chunk_overlap`
- 定期清理不需要的向量存储

## 示例输出解读

### 正常性能范围

**构建性能**（取决于文档数量）：
- 小规模（< 100 文档）：< 10 秒
- 中规模（100-1000 文档）：10-60 秒
- 大规模（> 1000 文档）：> 60 秒

**查询性能**（取决于 LLM 和重排序）：
- 无重排序：0.5-2 秒
- 有重排序：1-5 秒
- 使用本地模型（Ollama）：通常更快

**向量化速度**：
- 本地模型（Ollama）：10-50 块/秒
- 云端 API：取决于网络和 API 限制

## 自定义测试

你可以修改 `demo/RAG/benchmark.py` 中的测试参数：

```python
# 修改测试问题
test_questions = [
    "你的问题1",
    "你的问题2",
    # ...
]

# 修改构建参数
benchmark.benchmark_build(
    k=4,                    # 检索文档数量
    use_rerank=True,        # 是否使用重排序
    rerank_top_n=3,         # 重排序后保留的文档数
    force_rebuild=True      # 是否强制重建
)
```

## 故障排查

### 1. 内存监控不可用

**问题**：显示 "警告: psutil 未安装"

**解决**：
```bash
pip install psutil
```

### 2. 测试时间过长

**可能原因**：
- 文档数量过多
- 网络延迟（使用云端 API）
- 模型加载时间（首次使用）

**解决**：
- 使用已保存的向量存储（设置 `force_rebuild=False`）
- 使用本地模型（Ollama）
- 减少测试文档数量

### 3. 查询失败

**可能原因**：
- LLM 服务未启动
- API Key 未设置
- 网络连接问题

**解决**：
- 检查环境变量配置
- 确认服务正常运行
- 检查网络连接

## 定期性能监控

建议定期运行性能测试，监控系统性能变化：

1. **每次更新文档后**：测试构建性能
2. **每次更换模型后**：对比性能差异
3. **生产环境部署前**：确保性能满足要求

## 相关文档

- [README.md](README.md) - RAG 系统使用指南
- [VECTOR_STORE.md](VECTOR_STORE.md) - 向量存储说明
- [DEPLOY_RERANKER.md](DEPLOY_RERANKER.md) - 重排序部署指南
